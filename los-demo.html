<!DOCTYPE html>
<html>
<head>
    <title>Feature Layer Demo</title>
    <meta charset="utf-8" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="./NonTiledLayer.js"></script>
    <script src="./NonTiledLayer.WMS.js"></script>
    <script src="./Leaflet.PtvLayer.js"></script>
    <script src="./token.js"></script>
    <script type="text/javascript">
        var hour = 18;

        var url = 'https://xmap-eu-n-test.cloud.ptvgroup.com'

        var mapLocation = new L.LatLng(49.01, 8.4); // KA

        //set up the map
        map = new L.Map('map', {
            center: mapLocation,
            zoom: 14
        });

        //initialize layers
        var bgLayer = new L.PtvLayer.Tiled(url, {
            token: token, beforeSend: function (request) {
                request.callerContext.properties[0] = { key: "Profile", value: "silkysand-bg" };

                if (map.getZoom() < 10) // don't display los for low zoom levels
                    return request;

                request.mapParams.referenceTime = "2014-01-07T" + ((hour == 24) ? '00' : (hour >= 10) ? hour : '0' + hour) + ":00:00+02:00";
                request.callerContext.properties.push({
                    key: "ProfileXMLSnippet",
                    value: "<Profile xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:noNamespaceSchemaLocation=\"http://localhost:50010/xmap/schema/XMapProfile.xsd\"> <FeatureLayer majorVersion=\"1\" minorVersion=\"0\"> <GlobalSettings enableTimeDependency=\"true\"/> <Themes> <Theme enabled=\"true\" id=\"PTV_SpeedPatterns\"/> </Themes> </FeatureLayer> </Profile>"
                });

                return request;
            }
        }).addTo(map);

        // add (non-tiled) label layer. Default - insert at overlayPane
        var fgLayer = new L.NonTiledLayer.WMS(url + '/WMS/WMS?xtok=' + token, {
            opacity: 1.0,
            layers: 'xmap-ajaxfg-silkysand',
            format: 'image/png',
            transparent: true
        }).addTo(map);

        function setTime() {
            hour = range.value;
            bgLayer.redraw();
        }

        // add input control
        var info = L.control();
        info.onAdd = function (map) {
            var container = L.DomUtil.create('div', 'info leaflet-bar');
            var clickcmd = "if(!isBusy)findByAddress(document.getElementById('f1').value);";
            var fuzzySearchCmd = "if(!isBusy)findFuzzy(document.getElementById('f2').value);";
            var html =
            '<div>Select time of day</div>' +
            '<div>' +
			'00:00h <input id="range" type="range" min="0" max="24" step="1" value="' + hour + '" /> 24:00h ' +
			'</div>';
            container.innerHTML = html;
            fixClickPropagation(container);
            return container;
        };
        info.addTo(map);

        var range = document.getElementById('range');

        bgLayer.hour = range.value;

        range.onchange = setTime;
        range.oninput = setTime;

        function fixClickPropagation(container) {
            container.onclick = L.DomEvent.stopPropagation;
            var inputTags = container.getElementsByTagName("input");
            for (var i = 0; i < inputTags.length; i++) {
                if (inputTags[i].type == "text")
                    inputTags[i].onclick = L.DomEvent.stopPropagation;
                inputTags[i].onmousedown = inputTags[i].ondblclick = inputTags[i].onpointerdown = L.DomEvent.stopPropagation;
            }
        }
    </script>
</body>
</html>
